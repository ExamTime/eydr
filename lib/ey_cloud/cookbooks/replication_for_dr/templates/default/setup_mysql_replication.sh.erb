#!/bin/sh
/etc/init.d/mysql stop
rsync --exclude .svn --exclude mysql.d/replication.cnf -avz /db2/ /db/
/etc/init.d/mysql start
master_log_file=`cat /db/mysql/.snapshot_backup_master_status.txt | grep File | awk '{print $2}'`
master_log_pos=`cat /db/mysql/.snapshot_backup_master_status.txt | grep Position | awk '{print $2}'`
slave_status=`mysql -u root -p<%= @master_pass %> -e "show slave status \G"`
if [ ! -z "$slave_status" ]; then mysql -u root -p<%= @master_pass %> -e "stop slave"; fi
mysql -u root -p<%= @master_pass %> -e "CHANGE MASTER TO MASTER_HOST='127.0.0.1', MASTER_PORT=3307, MASTER_USER='replication', MASTER_PASSWORD='<%= @master_pass %>', MASTER_LOG_FILE='$master_log_file', MASTER_LOG_POS=$master_log_pos"
mysql -u root -p<%= @master_pass %> -e "start slave;"